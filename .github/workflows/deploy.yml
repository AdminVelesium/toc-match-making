name: Deploy Flask App to GCP VM

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Copy files to GCP VM via SCP
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.GCP_HOST }}
        username: ${{ secrets.GCP_USER }}
        key: ${{ secrets.GCP_SSH_KEY }}
        source: "."
        target: "/home/${{ secrets.GCP_USER }}/toc-match-making"

    - name: SSH into GCP VM and deploy
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.GCP_HOST }}
        username: ${{ secrets.GCP_USER }}
        key: ${{ secrets.GCP_SSH_KEY }}
        script: |
          cd ~/toc-match-making

          # Remove old virtualenv if exists
          rm -rf venv

          # Create new virtualenv
          python3 -m venv venv
          source venv/bin/activate

          # Install packages
          pip install -r requirements.txt

          # Write your API key into .env file
          echo 'GEMINI_API_KEY="AIzaSyD9LTTrXmvjzoV0vPOK7RVJSBv10tE7G1w"' > .env

          # Kill old running app if any
          pkill -f "python app.py" || true

          # Start app in background
          nohup venv/bin/python app.py > output.log 2>&1 &
